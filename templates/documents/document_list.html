{% extends 'base.html' %}

{% block title %}æ–‡æ¡£åˆ—è¡¨ - æ–‡æ¡£ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <!-- é¡µé¢æ ‡é¢˜å’Œæ“ä½œæŒ‰é’® -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">ğŸ“„ æ–‡æ¡£åˆ—è¡¨</h1>
            <p class="text-gray-600 mt-2">ç®¡ç†å’ŒæŸ¥çœ‹æ‚¨çš„æ–‡æ¡£</p>
        </div>
        <div class="flex space-x-3">
            <button onclick="openCreateModal()" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                â• æ–°å»ºæ–‡æ¡£
            </button>
            <button onclick="refreshDocuments()" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition-colors">
                ğŸ”„ åˆ·æ–°
            </button>
        </div>
    </div>

    <!-- æœç´¢å’Œç­›é€‰ -->
    <div class="bg-white rounded-lg shadow-sm border p-4 mb-6">
        <div class="flex flex-col sm:flex-row gap-4">
            <div class="flex-1">
                <input type="text" id="searchInput" placeholder="æœç´¢æ–‡æ¡£æ ‡é¢˜æˆ–å†…å®¹..." 
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
            </div>
            <div class="flex gap-2">
                <select id="categoryFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                    <option value="">æ‰€æœ‰åˆ†ç±»</option>
                </select>
            </div>
        </div>
    </div>

    <!-- æ–‡æ¡£åˆ—è¡¨ -->
    <div id="documentsContainer" class="space-y-4">
        <!-- åŠ è½½çŠ¶æ€ -->
        <div id="loadingState" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
            <p class="text-gray-500 mt-2">åŠ è½½ä¸­...</p>
        </div>
        
        <!-- ç©ºçŠ¶æ€ -->
        <div id="emptyState" class="text-center py-12 hidden">
            <div class="text-6xl mb-4">ğŸ“„</div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">æš‚æ— æ–‡æ¡£</h3>
            <p class="text-gray-500 mb-4">å¼€å§‹åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªæ–‡æ¡£å§ï¼</p>
            <button onclick="openCreateModal()" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                åˆ›å»ºæ–‡æ¡£
            </button>
        </div>

        <!-- æ–‡æ¡£å¡ç‰‡åˆ—è¡¨ -->
        <div id="documentsList" class="grid gap-4">
            <!-- æ–‡æ¡£å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <!-- åˆ†é¡µ -->
    <div id="pagination" class="flex justify-center mt-8 hidden">
        <nav class="flex space-x-2">
            <button id="prevPage" class="px-3 py-2 text-gray-500 hover:text-primary disabled:opacity-50" disabled>
                ä¸Šä¸€é¡µ
            </button>
            <span id="pageInfo" class="px-3 py-2 text-gray-700"></span>
            <button id="nextPage" class="px-3 py-2 text-gray-500 hover:text-primary disabled:opacity-50" disabled>
                ä¸‹ä¸€é¡µ
            </button>
        </nav>
    </div>
</div>

<!-- æ–°å»ºæ–‡æ¡£æ¨¡æ€æ¡† -->
<div id="createModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">åˆ›å»ºæ–°æ–‡æ¡£</h3>
                <form id="createForm">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ ‡é¢˜</label>
                        <input type="text" id="documentTitle" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">åˆ†ç±»</label>
                        <select id="documentCategory" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                            <option value="">é€‰æ‹©åˆ†ç±»</option>
                        </select>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">å†…å®¹</label>
                        <textarea id="documentContent" rows="4"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"></textarea>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">
                            å–æ¶ˆ
                        </button>
                        <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-700">
                            åˆ›å»º
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// å…¨å±€å˜é‡
let documents = [];
let categories = [];
let currentPage = 1;
let totalPages = 1;

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    loadCategories();
    loadDocuments();
    setupEventListeners();
});

// è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
function setupEventListeners() {
    // æœç´¢åŠŸèƒ½
    document.getElementById('searchInput').addEventListener('input', debounce(searchDocuments, 300));
    
    // åˆ†ç±»ç­›é€‰
    document.getElementById('categoryFilter').addEventListener('change', loadDocuments);
    
    // åˆ†é¡µ
    document.getElementById('prevPage').addEventListener('click', () => changePage(-1));
    document.getElementById('nextPage').addEventListener('click', () => changePage(1));
    
    // åˆ›å»ºè¡¨å•
    document.getElementById('createForm').addEventListener('submit', submitCreateDocument);
}

// åŠ è½½åˆ†ç±»
async function loadCategories() {
    try {
        console.log('å¼€å§‹åŠ è½½åˆ†ç±»...');
        const response = await fetch('/api/documents/categories/');
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('åˆ†ç±»æ•°æ®:', data);
        
        // å¤„ç†APIå“åº”æ•°æ®
        if (data.results) {
            categories = data.results;
        } else if (Array.isArray(data)) {
            categories = data;
        } else {
            categories = [];
        }
        
        const categoryFilter = document.getElementById('categoryFilter');
        const documentCategory = document.getElementById('documentCategory');
        
        // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™é»˜è®¤é€‰é¡¹ï¼‰
        categoryFilter.innerHTML = '<option value="">æ‰€æœ‰åˆ†ç±»</option>';
        documentCategory.innerHTML = '<option value="">é€‰æ‹©åˆ†ç±»</option>';
        
        // æ·»åŠ åˆ†ç±»é€‰é¡¹
        categories.forEach(category => {
            const option1 = new Option(category.name, category.id);
            const option2 = new Option(category.name, category.id);
            categoryFilter.appendChild(option1);
            documentCategory.appendChild(option2);
        });
        
        console.log(`æˆåŠŸåŠ è½½ ${categories.length} ä¸ªåˆ†ç±»`);
        
    } catch (error) {
        console.error('åŠ è½½åˆ†ç±»å¤±è´¥:', error);
        // æ˜¾ç¤ºé”™è¯¯æç¤º
        const categoryFilter = document.getElementById('categoryFilter');
        const documentCategory = document.getElementById('documentCategory');
        
        categoryFilter.innerHTML = '<option value="">åŠ è½½åˆ†ç±»å¤±è´¥</option>';
        documentCategory.innerHTML = '<option value="">åŠ è½½åˆ†ç±»å¤±è´¥</option>';
    }
}

// åŠ è½½æ–‡æ¡£
async function loadDocuments() {
    showLoading();
    
    try {
        const searchTerm = document.getElementById('searchInput').value;
        const categoryId = document.getElementById('categoryFilter').value;
        
        let url = `/api/documents/documents/?page=${currentPage}`;
      
        if (searchTerm) {
            url += `&search=${encodeURIComponent(searchTerm)}`;
        }
        if (categoryId) {
            url += `&category=${categoryId}`;
        }
        
        console.log('è¯·æ±‚URL:', url);
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('æ–‡æ¡£æ•°æ®:', data);
        
        // å¤„ç†APIå“åº”æ•°æ®
        if (data.results) {
            documents = data.results;
        } else if (Array.isArray(data)) {
            documents = data;
        } else {
            documents = [];
        }
        
        console.log(`æˆåŠŸåŠ è½½ ${documents.length} ä¸ªæ–‡æ¡£`);
        renderDocuments();
        updatePagination(data);
        
    } catch (error) {
        console.error('åŠ è½½æ–‡æ¡£å¤±è´¥:', error);
        showError('åŠ è½½æ–‡æ¡£å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
}

// æ¸²æŸ“æ–‡æ¡£åˆ—è¡¨
function renderDocuments() {
    const container = document.getElementById('documentsList');
    const loadingState = document.getElementById('loadingState');
    const emptyState = document.getElementById('emptyState');
    
    // éšè—åŠ è½½çŠ¶æ€
    loadingState.classList.add('hidden');
    
    // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
    if (!documents || documents.length === 0) {
        emptyState.classList.remove('hidden');
        container.innerHTML = '';
        return;
    }
    
    // æœ‰æ•°æ®æ—¶éšè—ç©ºçŠ¶æ€
    emptyState.classList.add('hidden');
    
    // æ¸²æŸ“æ–‡æ¡£åˆ—è¡¨
    container.innerHTML = documents.map(doc => `
        <div class="bg-white rounded-lg shadow-sm border p-6 hover:shadow-md transition-shadow">
            <div class="flex justify-between items-start mb-3">
                <h3 class="text-lg font-semibold text-gray-900">${doc.title}</h3>
                <div class="flex space-x-2">
                    <button onclick="deleteDocument(${doc.id})" class="text-red-600 hover:text-red-800 text-sm">
                        åˆ é™¤
                    </button>
                </div>
            </div>
            <div class="text-gray-600 text-sm mb-3">
                <span class="inline-block bg-gray-100 px-2 py-1 rounded text-xs mr-2">
                    ${doc.category ? doc.category.name : 'æœªåˆ†ç±»'}
                </span>
                <span class="text-gray-500">
                    ä½œè€…: ${doc.author.username} | 
                    åˆ›å»º: ${new Date(doc.created_at).toLocaleDateString()}
                </span>
            </div>
        </div>
    `).join('');
}

// æ›´æ–°åˆ†é¡µ
function updatePagination(data) {
    const pagination = document.getElementById('pagination');
    const prevBtn = document.getElementById('prevPage');
    const nextBtn = document.getElementById('nextPage');
    const pageInfo = document.getElementById('pageInfo');
    
    if (data.count && data.count > 10) {
        pagination.classList.remove('hidden');
        totalPages = Math.ceil(data.count / 10);
        
        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = currentPage === totalPages;
        
        pageInfo.textContent = `ç¬¬ ${currentPage} é¡µï¼Œå…± ${totalPages} é¡µ`;
    } else {
        pagination.classList.add('hidden');
    }
}

// æ˜¾ç¤ºåŠ è½½çŠ¶æ€
function showLoading() {
    document.getElementById('loadingState').classList.remove('hidden');
    document.getElementById('emptyState').classList.add('hidden');
    document.getElementById('documentsList').innerHTML = '';
}

// æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
function showError(message) {
    alert(message);
}

// é˜²æŠ–å‡½æ•°
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// æœç´¢æ–‡æ¡£
function searchDocuments() {
    currentPage = 1;
    loadDocuments();
}

// åˆ‡æ¢é¡µé¢
function changePage(direction) {
    const newPage = currentPage + direction;
    if (newPage >= 1 && newPage <= totalPages) {
        currentPage = newPage;
        loadDocuments();
    }
}

// æ‰“å¼€åˆ›å»ºæ–‡æ¡£æ¨¡æ€æ¡†
function openCreateModal() {
    document.getElementById('createModal').classList.remove('hidden');
}

// å…³é—­æ¨¡æ€æ¡†
function closeModal() {
    document.getElementById('createModal').classList.add('hidden');
    document.getElementById('createForm').reset();
}

// æäº¤åˆ›å»ºè¡¨å•
async function submitCreateDocument(event) {
    if (event) event.preventDefault();
    
    const title = document.getElementById('documentTitle').value;
    const content = document.getElementById('documentContent').value;
    const categoryId = document.getElementById('documentCategory').value;
    
    if (!title.trim()) {
        alert('è¯·è¾“å…¥æ–‡æ¡£æ ‡é¢˜');
        return;
    }
    
    try {
        const response = await fetch('/api/documents/documents/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                title: title,
                content: content,
                category: categoryId || null
            })
        });
        
        if (response.ok) {
            closeModal();
            // é‡ç½®æœç´¢å’Œç­›é€‰æ¡ä»¶
            document.getElementById('searchInput').value = '';
            document.getElementById('categoryFilter').value = '';
            currentPage = 1;
            loadDocuments();
            alert('æ–‡æ¡£åˆ›å»ºæˆåŠŸï¼');
        } else {
            const error = await response.json();
            alert('åˆ›å»ºå¤±è´¥: ' + (error.detail || 'æœªçŸ¥é”™è¯¯'));
        }
    } catch (error) {
        console.error('åˆ›å»ºæ–‡æ¡£å¤±è´¥:', error);
        alert('åˆ›å»ºæ–‡æ¡£å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
}

// ç¼–è¾‘æ–‡æ¡£
function editDocument(id) {
    alert('ç¼–è¾‘åŠŸèƒ½å¾…å®ç°');
}

// åˆ é™¤æ–‡æ¡£
async function deleteDocument(id) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡æ¡£å—ï¼Ÿ')) return;
    
    try {
        const response = await fetch(`/api/documents/documents/${id}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        if (response.ok) {
            loadDocuments();
            alert('æ–‡æ¡£åˆ é™¤æˆåŠŸï¼');
        } else {
            alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    } catch (error) {
        console.error('åˆ é™¤æ–‡æ¡£å¤±è´¥:', error);
        alert('åˆ é™¤æ–‡æ¡£å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
}

// åˆ·æ–°æ–‡æ¡£
function refreshDocuments() {
    currentPage = 1;
    loadDocuments();
}

// è·å–CSRF Token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
